name: Zillow Analysis

on:
  workflow_run:
    workflows: ["Scrape Zillow Listings"]
    types: [completed]

jobs:
  zillow_analysis_job:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install Dependencies
        run: pip install requests beautifulsoup4 openai lxml

      - name: Fetch Latest Release
        id: fetch_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching the latest release..."
          response=$(curl -sSL -H "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/repos/${{ github.repository }}/releases/latest)
          echo "$response" > latest_release.json
          body=$(echo "$response" | python -c "import sys, json; obj=json.load(sys.stdin); print(obj.get('body',''))")
          tag_name=$(echo "$response" | python -c "import sys, json; obj=json.load(sys.stdin); print(obj.get('tag_name',''))")
          echo "Found release tag_name=$tag_name"
          echo "release_body<<EOF" >> "$GITHUB_OUTPUT"
          echo "$body" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "release_tag=$tag_name" >> "$GITHUB_OUTPUT"

      - name: Check if release is Zillow update
        id: check_zillow
        run: |
          TAG_NAME="${{ steps.fetch_release.outputs.release_tag }}"
          if [[ "$TAG_NAME" == zillow-updates-* ]]; then
            echo "is_zillow=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_zillow=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate Timestamp
        id: gen_ts
        if: steps.check_zillow.outputs.is_zillow == 'true'
        run: |
          TS=$(date +'%Y-%m-%d_%H-%M-%S')
          echo "timestamp=$TS" >> "$GITHUB_OUTPUT"

      - name: Run Zillow to Text Analysis
        id: z2t
        if: steps.check_zillow.outputs.is_zillow == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Write the release body (with new listing info and detail URLs) to a file.
          echo "${{ steps.fetch_release.outputs.release_body }}" > release_body.txt
          # The updated Python script will:
          #   - Parse release_body.txt to extract each listingâ€™s detail URL.
          #   - For each URL, fetch the Zillow page using robust headers (like in the first workflow)
          #     and extract its full text.
          #   - Construct a prompt asking ChatGPT to generate a property grade and an exactly 50-word description.
          #   - Aggregate the responses.
          python .github/scripts/zillow_to_text.py release_body.txt > z2t_output.txt
          echo "analysis<<EOF" >> "$GITHUB_OUTPUT"
          cat z2t_output.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create or Update Release with AI Summary
        if: steps.check_zillow.outputs.is_zillow == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "zillow-analysis-${{ steps.gen_ts.outputs.timestamp }}"
          release_name: "Zillow Analysis #${{ steps.gen_ts.outputs.timestamp }}"
          body: ${{ steps.z2t.outputs.analysis }}
          draft: false
          prerelease: false

      - name: Update GitHub Pages Analysis File
        if: steps.check_zillow.outputs.is_zillow == 'true'
        run: |
          mkdir -p _includes
          echo "${{ steps.z2t.outputs.analysis }}" > _includes/analysis.md
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add _includes/analysis.md
          git commit -m "Update analysis.md with latest Zillow analysis"
          git push
